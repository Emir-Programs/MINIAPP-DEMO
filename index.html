<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram Mini App ‚Äî –ü—Ä–∏–º–µ—Ä</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #fff;
      --muted: #6b7280;
      --accent: #1f8ef1;
      --danger: #e11d48;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body { height:100%; margin:0; background:var(--bg); }
    .wrap {
      max-width:720px;
      margin:32px auto;
      padding:20px;
    }
    .card {
      background:var(--card);
      border-radius:12px;
      box-shadow:0 6px 18px rgba(20,20,40,0.06);
      padding:20px;
    }
    h1 { margin:0 0 8px 0; font-size:20px; }
    p.muted { color:var(--muted); margin:0 0 16px 0; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .info {
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:10px;
      background:#fbfdff;
      width:100%;
    }
    .avatar {
      width:48px; height:48px; border-radius:12px; background:#eef6ff; display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--accent);
      font-size:18px;
    }
    .meta { display:flex; flex-direction:column; }
    button, .btn {
      appearance:none;
      border:0;
      background:var(--accent);
      color:white;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.ghost { background:transparent; color:var(--accent); border:1px solid rgba(31,142,241,0.12); }
    .btn.danger { background:var(--danger); }
    pre { background:#f8fafc; padding:12px; border-radius:8px; overflow:auto; }
    footer { margin-top:16px; color:var(--muted); font-size:13px; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>–ü—Ä–∏–º–µ—Ä Telegram Mini App</h1>
      <p class="muted">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —à–∞–±–ª–æ–Ω: –ø–æ–ª—É—á–∞—Ç—å –∏–º—è, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É –∏ –∑–∞–∫—Ä—ã–≤–∞—Ç—å WebApp.</p>

      <div class="row">
        <div class="info" id="userCard">
          <div class="avatar" id="avatar">‚Äî</div>
          <div class="meta">
            <div id="fullname" style="font-weight:700">–ì–æ—Å—Ç—å</div>
            <div id="username" style="color:var(--muted)">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="row">
        <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É</button>
        <button id="closeBtn" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button id="mainBtnToggle" class="btn ghost">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å MainButton</button>
        <button id="revealInit" class="btn ghost">–ü–æ–∫–∞–∑–∞—Ç—å initData</button>
      </div>

      <div class="row">
        <div style="flex:1;">
          <label style="display:block; font-weight:600; margin-bottom:6px;">–°–æ–æ–±—â–µ–Ω–∏–µ (–±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É):</label>
          <textarea id="payload" style="width:100%; min-height:84px; padding:10px; border-radius:8px; border:1px solid #eef2f7;">{"action":"purchase","item":"demo_pack","price":49}</textarea>
        </div>
      </div>

      <div class="row">
        <details style="width:100%;">
          <summary style="cursor:pointer; padding:8px 12px; border-radius:8px; background:#fbfdff;">–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</summary>
          <div style="padding:12px;">
            <div><strong>isClosed:</strong> <span id="isClosed">false</span></div>
            <div style="margin-top:8px;"><strong>initData (unsafe):</strong></div>
            <pre id="initData">‚Äî</pre>
          </div>
        </details>
      </div>

      <footer>–ü–æ–¥–∫–ª—é—á–∞–π URL –∫ –∫–Ω–æ–ø–∫–µ –±–æ—Ç–∞ –∫–∞–∫ <code>web_app</code>. –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –≤ –∫–æ–¥–µ –Ω–µ –Ω—É–∂–µ–Ω.</footer>
    </div>
  </div>

  <script>
    // Telegram WebApp SDK
    const tg = window.Telegram?.WebApp;

    if (!tg) {
      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –∏–∑ Telegram ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      document.getElementById('fullname').textContent = '–û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –∏–∑ Telegram';
      document.getElementById('username').textContent = '–ó–∞–ø—É—Å—Ç–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ / Web App';
      document.getElementById('avatar').textContent = 'üö´';
      document.getElementById('initData').textContent = 'telegram-web-app.js –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.';
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('mainBtnToggle').disabled = true;
      document.getElementById('closeBtn').addEventListener('click', () => window.close());
    } else {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      tg.expand(); // —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
      const user = tg.initDataUnsafe?.user || null;
      document.getElementById('initData').textContent = JSON.stringify(tg.initDataUnsafe, null, 2);

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
      if (user) {
        const name = [user.first_name, user.last_name].filter(Boolean).join(' ');
        document.getElementById('fullname').textContent = name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram';
        document.getElementById('username').textContent = user.username ? '@' + user.username : '–±–µ–∑ username';
        document.getElementById('avatar').textContent = (user.first_name || 'U').slice(0,1).toUpperCase();
      } else {
        document.getElementById('fullname').textContent = '–ì–æ—Å—Ç—å';
        document.getElementById('username').textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        document.getElementById('avatar').textContent = 'G';
      }

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
      tg.onEvent('mainButtonClicked', () => {
        // main button –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω ‚Äî —Ç—É—Ç –ø—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
        // (–≤ —ç—Ç–æ–º —à–∞–±–ª–æ–Ω–µ –º—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å –æ—Å–Ω–æ–≤. –∫–Ω–æ–ø–∫–∏)
        console.log('MainButton clicked');
      });

      // –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É"
      document.getElementById('sendBtn').addEventListener('click', () => {
        let raw = document.getElementById('payload').value;
        let safe;
        try {
          safe = JSON.parse(raw);
        } catch (e) {
          alert('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –≤ –ø–æ–ª–µ payload. –ò—Å–ø—Ä–∞–≤—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.');
          return;
        }

        // –î–æ–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
        const packageToSend = {
          webapp_action: 'user_event',
          user: tg.initDataUnsafe?.user || null,
          payload: safe,
          ts: Date.now(),
        };

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É: –±–æ—Ç –ø–æ–ª—É—á–∏—Ç update.message.web_app_data.data (—Å—Ç—Ä–æ–∫–∞)
        tg.sendData(JSON.stringify(packageToSend));
        // –î–ª—è UX –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å WebApp (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
        tg.close();
      });

      // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç—å
      document.getElementById('closeBtn').addEventListener('click', () => tg.close());

      // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ MainButton (–Ω–∏–∂–Ω—è—è –Ω–∞—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ Telegram)
      let mainShown = false;
      const mainToggle = document.getElementById('mainBtnToggle');
      mainToggle.addEventListener('click', () => {
        if (!mainShown) {
          tg.MainButton.setText('–ö—É–ø–∏—Ç—å ‚Äî 49');
          tg.MainButton.show();
          mainShown = true;
        } else {
          tg.MainButton.hide();
          mainShown = false;
        }
      });

      // –ö–Ω–æ–ø–∫–∞ initData –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      document.getElementById('revealInit').addEventListener('click', () => {
        document.getElementById('initData').textContent = JSON.stringify(tg.initDataUnsafe, null, 2);
        document.getElementById('isClosed').textContent = tg.isClosed ? 'true' : 'false';
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º initData –≤ –º–æ–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏
      document.getElementById('initData').textContent = JSON.stringify(tg.initDataUnsafe, null, 2);
      document.getElementById('isClosed').textContent = tg.isClosed ? 'true' : 'false';
    }

    // –ù–µ–±–æ–ª—å—à–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞: –∫–∞–∫ –±–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ
    // –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞ ‚Äî –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—è–π message.web_app_data.data
    // (—ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ ‚Äî JSON, –∫–æ—Ç–æ—Ä—ã–π –º—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —á–µ—Ä–µ–∑ tg.sendData)
  </script>
</body>
</html>
